import streamlit as st
import pandas as pd
import pydeck as pdk

# ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
@st.cache_data
def load_data():
    df = pd.read_csv("growup.csv", encoding="cp949")
    return df

df = load_data()

# ì¢Œí‘œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° (ì„œìš¸ ì‹œêµ°êµ¬ ì¤‘ì‹¬ ìœ„ë„/ê²½ë„, í•„ìš”ì‹œ ì „êµ­ìœ¼ë¡œ í™•ì¥ ê°€ëŠ¥)
# ì—¬ê¸°ì„  ì„œìš¸ ì‹œêµ°êµ¬ ì˜ˆì‹œ (ìˆ˜ë™ ì„¤ì • ë˜ëŠ” geopyë¡œ ìë™í™” ê°€ëŠ¥)
locations = {
    "ì¢…ë¡œêµ¬": [37.573050, 126.979189],
    "ì¤‘êµ¬": [37.563750, 126.997559],
    "ìš©ì‚°êµ¬": [37.532600, 126.990100],
    "ì„±ë™êµ¬": [37.563400, 127.036100],
    "ê´‘ì§„êµ¬": [37.538400, 127.082800],
    "ë™ëŒ€ë¬¸êµ¬": [37.5744, 127.0396],
    "ì¤‘ë‘êµ¬": [37.6063, 127.0927],
    "ì„±ë¶êµ¬": [37.5894, 127.0167],
    "ê°•ë¶êµ¬": [37.6396, 127.0253],
    "ë„ë´‰êµ¬": [37.6688, 127.0472],
    "ë…¸ì›êµ¬": [37.6543, 127.0568],
    "ì€í‰êµ¬": [37.6176, 126.9227],
    "ì„œëŒ€ë¬¸êµ¬": [37.5792, 126.9368],
    "ë§ˆí¬êµ¬": [37.5663, 126.9013],
    "ì–‘ì²œêµ¬": [37.5172, 126.8664],
    "ê°•ì„œêµ¬": [37.5509, 126.8495],
    "êµ¬ë¡œêµ¬": [37.4955, 126.8877],
    "ê¸ˆì²œêµ¬": [37.4601, 126.9007],
    "ì˜ë“±í¬êµ¬": [37.5264, 126.8962],
    "ë™ì‘êµ¬": [37.5124, 126.9395],
    "ê´€ì•…êµ¬": [37.4784, 126.9516],
    "ì„œì´ˆêµ¬": [37.4836, 127.0326],
    "ê°•ë‚¨êµ¬": [37.5172, 127.0473],
    "ì†¡íŒŒêµ¬": [37.5145, 127.1059],
    "ê°•ë™êµ¬": [37.5302, 127.1238]
}

# ì‚¬ìš©ì ì„ íƒ: ì—°ë„
years = df["ì—°ë„"].unique()
selected_year = st.selectbox("ì—°ë„ ì„ íƒ", sorted(years, reverse=True))
df_year = df[df["ì—°ë„"] == selected_year].copy()

# ì¢Œí‘œ ì¶”ê°€
df_year["ìœ„ë„"] = df_year["ì‹œêµ°êµ¬"].map(lambda x: locations.get(x, [None, None])[0])
df_year["ê²½ë„"] = df_year["ì‹œêµ°êµ¬"].map(lambda x: locations.get(x, [None, None])[1])
df_year = df_year.dropna(subset=["ìœ„ë„", "ê²½ë„"])

# ì•ŒíŒŒê°’(ì§„í•™ë¥  ì‹œê°í™”ìš©)
max_rate = df_year["ì§„í•™ë¥ "].max()
df_year["alpha"] = (df_year["ì§„í•™ë¥ "] / max_rate * 255).clip(50, 255).astype(int)

# ì§€ë„ ì‹œê°í™”
st.subheader("ğŸ—ºï¸ ì‹œêµ°êµ¬ë³„ ëŒ€í•™ ì§„í•™ë¥  ì§€ë„")

layer = pdk.Layer(
    "ScatterplotLayer",
    data=df_year,
    get_position='[ê²½ë„, ìœ„ë„]',
    get_fill_color='[30, 144, 255, alpha]',  # íŒŒë€ìƒ‰ ê³„ì—´
    get_radius=8000,
    pickable=True
)

view_state = pdk.ViewState(
    latitude=37.55,
    longitude=126.98,
    zoom=10,
    pitch=20
)

st.pydeck_chart(pdk.Deck(
    map_style=None,  # âœ… API ì—†ì´ ì§€ë„ ì‚¬ìš©
    initial_view_state=view_state,
    layers=[layer],
    tooltip={"text": "{ì‹œêµ°êµ¬}\nì§„í•™ë¥ : {ì§„í•™ë¥ }%"}
))
